<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Track your merchant payment page status and activity"
    />
    <meta
      name="keywords"
      content="track payment, USDC, crypto payments, transaction, polygon, merchant payment"
    />
    <meta name="author" content="Transact.st" />
    <meta name="robots" content="index, follow" />

    <meta property="og:title" content="Transact | Payment Tracking" />
    <meta
      property="og:description"
      content="Track your merchant payment page status and activity"
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://transact.st/tracking" />
    <meta property="og:image" content="https://transact.st/og-image.jpg" />

    <link rel="icon" href="images/favicon.ico" />
    <title>Transact | Payment Tracking</title>
    <link rel="canonical" href="https://transact.st/tracking" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/accessibility-fixes.css" />
  </head>
  <body>
    <header class="py-4 bg-gradient">
      <div class="container">
        <div class="d-flex align-items-center justify-content-between">
          <a href="/" class="logo-link">
            <h1 class="mb-0">
              <i class="fas fa-exchange-alt me-2"></i>Transact.st
            </h1>
          </a>
          <div class="theme-switcher">
            <button
              id="theme-toggle"
              class="btn btn-sm btn-outline-light"
              aria-label="Toggle theme"
            >
              <i class="fas fa-moon" aria-hidden="true"></i>
              <span class="visually-hidden">Toggle theme</span>
            </button>
          </div>
        </div>
      </div>
    </header>

    <div class="container py-5">
      <div class="card main-card mb-4">
        <div class="card-header bg-transparent">
          <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0 h3">
              <i class="fas fa-chart-line me-2 accent-icon"></i>Payment Tracking
            </h2>
            <span class="badge feature-badge">Merchant Tool</span>
          </div>
        </div>
        <div class="card-body">
          <p class="mb-4 lead">
            Track the status and activity of your merchant payment page.
          </p>

          <div class="row">
            <div class="col-md-12">
              <div class="mb-4">
                <label for="ref-code" class="form-label">Reference Code:</label>
                <div class="input-group mb-3">
                  <span class="input-group-text"><i class="fas fa-hashtag"></i></span>
                  <input
                    type="text"
                    class="form-control"
                    id="ref-code"
                    readonly
                    placeholder="Payment reference code"
                  />
                </div>
              </div>
              
              <div id="tracking-info" class="mb-4">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>
                  <span>This tracking page shows basic information about your merchant payment page. For more advanced tracking features, please contact support.</span>
                </div>
                
                <div class="card mb-3">
                  <div class="card-body">
                    <h5 class="card-title"><i class="fas fa-link me-2"></i>Merchant Payment Link</h5>
                    <p class="card-text mb-3">This is the payment page where your customers can make payments.</p>
                    
                    <div id="payment-url-container" class="mb-3">
                      <div class="input-group">
                        <input type="text" class="form-control" id="payment-url" readonly/>
                        <button class="btn btn-outline-secondary" type="button" id="copy-payment-url" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy to Clipboard">
                          <i class="fas fa-copy"></i>
                        </button>
                      </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                      <a id="open-payment-link" href="#" target="_blank" class="btn btn-primary">
                        <i class="fas fa-external-link-alt me-2"></i>Open Payment Page
                      </a>
                    </div>
                  </div>
                </div>
                
                <div class="card mb-3">
                  <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-wallet me-2"></i>Wallet Information</h5>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label fw-bold">Wallet Address:</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="wallet-address" readonly/>
                        <button class="btn btn-outline-secondary" type="button" id="copy-wallet" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy to Clipboard">
                          <i class="fas fa-copy"></i>
                        </button>
                      </div>
                    </div>
                    <div class="alert alert-success">
                      <i class="fas fa-check-circle me-2"></i>
                      <span>This wallet address is securely locked in your payment link.</span>
                    </div>
                  </div>
                </div>
                
                <div class="card mb-3">
                  <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Security Information</h5>
                  </div>
                  <div class="list-group list-group-flush">
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <i class="fas fa-lock text-success me-2"></i>
                        <span>Wallet Address Encryption</span>
                      </div>
                      <span class="badge bg-success rounded-pill">Active</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <i class="fas fa-eye-slash text-success me-2"></i>
                        <span id="hide-wallet-status">Wallet Address Visibility</span>
                      </div>
                      <span id="hide-wallet-badge" class="badge rounded-pill">Unknown</span>
                    </div>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <i class="fas fa-filter text-success me-2"></i>
                        <span>Provider Restrictions</span>
                      </div>
                      <span id="provider-restrictions-badge" class="badge bg-success rounded-pill">Active</span>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="d-grid gap-2 mt-4">
                <a href="/" class="btn btn-outline-primary">
                  <i class="fas fa-home me-2"></i>Back to Home
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer py-4 bg-light">
      <div class="container">
        <div class="row">
          <div class="col-md-6">
            <p class="mb-0">
              &copy; 2023-2024 Transact.st | All rights reserved
            </p>
          </div>
          <div class="col-md-6 text-md-end">
            <a href="#" class="text-decoration-none me-3">Terms</a>
            <a href="#" class="text-decoration-none">Privacy</a>
          </div>
        </div>
      </div>
    </footer>

    <div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      // Constants
      const ENCRYPTION_KEY = "Transact.st:8a7b6c5d4e3f2g1h";
      
      // Utility functions
      function showToast(message, type = "info") {
        const toastContainer = document.querySelector('.toast-container');
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white bg-${type} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.setAttribute('aria-live', 'assertive');
        toastEl.setAttribute('aria-atomic', 'true');
        
        toastEl.innerHTML = `
          <div class="d-flex">
            <div class="toast-body">
              <i class="fas fa-${type === 'info' ? 'info-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
              ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        `;
        
        toastContainer.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
        toast.show();
        
        // Remove the toast element when hidden
        toastEl.addEventListener('hidden.bs.toast', () => {
          toastEl.remove();
        });
      }
      
      function copyToClipboard(text) {
        const el = document.createElement('input');
        el.value = text;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
      }
      
      function setupCopyButtons() {
        // Setup copying for wallet address
        const copyWalletBtn = document.getElementById('copy-wallet');
        if (copyWalletBtn) {
          copyWalletBtn.addEventListener('click', () => {
            const walletAddress = document.getElementById('wallet-address').value;
            copyToClipboard(walletAddress);
            
            // Update tooltip
            const tooltip = bootstrap.Tooltip.getInstance(copyWalletBtn);
            copyWalletBtn.setAttribute('data-bs-original-title', 'Copied!');
            tooltip.update();
            
            setTimeout(() => {
              copyWalletBtn.setAttribute('data-bs-original-title', 'Copy to Clipboard');
              tooltip.update();
            }, 2000);
          });
        }
        
        // Setup copying for payment URL
        const copyPaymentUrlBtn = document.getElementById('copy-payment-url');
        if (copyPaymentUrlBtn) {
          copyPaymentUrlBtn.addEventListener('click', () => {
            const paymentUrl = document.getElementById('payment-url').value;
            copyToClipboard(paymentUrl);
            
            // Update tooltip
            const tooltip = bootstrap.Tooltip.getInstance(copyPaymentUrlBtn);
            copyPaymentUrlBtn.setAttribute('data-bs-original-title', 'Copied!');
            tooltip.update();
            
            setTimeout(() => {
              copyPaymentUrlBtn.setAttribute('data-bs-original-title', 'Copy to Clipboard');
              tooltip.update();
            }, 2000);
          });
        }
      }
      
      function validateWalletAddress(address) {
        return /^0x[a-fA-F0-9]{40}$/.test(address);
      }
      
      async function decryptData(encryptedData) {
        try {
          // Fix base64 padding
          let base64 = encryptedData.replace(/-/g, '+').replace(/_/g, '/');
          while (base64.length % 4) {
            base64 += '=';
          }
          
          // Decode base64
          const binaryString = atob(base64);
          
          // Check format type
          if (binaryString.startsWith('F1:')) {
            // Legacy format (fallback encryption)
            const parts = binaryString.split(':');
            if (parts.length !== 4) {
              throw new Error('Invalid encrypted data format');
            }
            
            const salt = parts[1];
            const hashCheck = parts[2];
            const encryptedContent = parts[3];
            
            // Reconstruct key with salt
            const key = ENCRYPTION_KEY + salt;
            let content = encryptedContent;
            
            // Apply decryption rounds
            for (let round = 2; round >= 0; round--) {
              let result = '';
              for (let i = 0; i < content.length; i++) {
                const keyByte = key.charCodeAt((i * round + i) % key.length);
                const prevByte = i > 0 ? content.charCodeAt(i - 1) : 0;
                const byte = content.charCodeAt(i) ^ keyByte ^ (prevByte >> 3);
                result += String.fromCharCode(byte);
              }
              content = result;
            }
            
            // Validate integrity with hash check
            let hash = 0;
            for (let i = 0; i < content.length; i++) {
              hash = ((hash * 31) + content.charCodeAt(i)) >>> 0;
            }
            
            if (hash.toString(16) !== hashCheck) {
              console.error('Integrity check failed');
              return null;
            }
            
            try {
              // Try to parse as JSON (new format)
              const walletData = JSON.parse(content);
              if (walletData && walletData.address) {
                // New format with hideWallet flag
                if (!validateWalletAddress(walletData.address)) {
                  console.error('Decrypted value is not a valid wallet address');
                  return null;
                }
                return walletData;
              }
            } catch (e) {
              // If not valid JSON, it's the old format with only wallet address
              if (validateWalletAddress(content)) {
                return { 
                  address: content,
                  hideWallet: false 
                };
              }
              console.error('Decrypted value is not a valid wallet address or wallet data');
              return null;
            }
          } else {
            // Modern format
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
              bytes[i] = binaryString.charCodeAt(i);
            }
            
            // Extract IV, MAC and ciphertext
            const iv = bytes.slice(0, 16);
            const mac = bytes.slice(16, 48);
            const ciphertext = bytes.slice(48);
            
            // Prepare key
            const keyBytes = new TextEncoder().encode(ENCRYPTION_KEY);
            
            // Initialize S-box
            const sBox = new Uint8Array(256);
            for (let i = 0; i < 256; i++) {
              sBox[i] = i;
            }
            
            // KSA with IV
            let j = 0;
            for (let i = 0; i < 256; i++) {
              j = (j + sBox[i] + keyBytes[i % keyBytes.length] + iv[i % iv.length]) % 256;
              [sBox[i], sBox[j]] = [sBox[j], sBox[i]];
            }
            
            // Decrypt
            const plaintext = new Uint8Array(ciphertext.length);
            for (let i = 0; i < ciphertext.length; i++) {
              const a = (i + 1) % 256;
              const b = (sBox[a] + sBox[i % 256]) % 256;
              [sBox[a], sBox[b]] = [sBox[b], sBox[a]];
              const k = sBox[(sBox[a] + sBox[b]) % 256];
              plaintext[i] = ciphertext[i] ^ k;
            }
            
            // Verify MAC
            const calculatedMac = new Uint8Array(32);
            for (let i = 0; i < 32; i++) {
              let val = iv[i % iv.length];
              for (let j = 0; j < plaintext.length; j++) {
                val ^= plaintext[j];
                val = ((val << 1) | (val >> 7)) & 0xFF;
              }
              calculatedMac[i] = val;
            }
            
            // Check if MACs match
            let macsMatch = true;
            for (let i = 0; i < 32; i++) {
              if (mac[i] !== calculatedMac[i]) {
                macsMatch = false;
                break;
              }
            }
            
            if (!macsMatch) {
              console.error('Integrity check failed');
              return null;
            }
            
            // Convert to string and parse JSON
            const decodedText = new TextDecoder().decode(plaintext);
            try {
              // Try to parse as JSON (new format)
              const walletData = JSON.parse(decodedText);
              if (walletData && walletData.address) {
                // New format with hideWallet flag
                if (!validateWalletAddress(walletData.address)) {
                  console.error('Decrypted value is not a valid wallet address');
                  return null;
                }
                return walletData;
              }
            } catch (e) {
              // If not valid JSON, it's the old format with only wallet address
              if (validateWalletAddress(decodedText)) {
                return { 
                  address: decodedText,
                  hideWallet: false 
                };
              }
              console.error('Decrypted value is not a valid wallet address or wallet data');
              return null;
            }
          }
          return null;
        } catch (error) {
          console.error('Decryption error:', error);
          return null;
        }
      }
      
      // Main initialization
      document.addEventListener('DOMContentLoaded', async () => {
        // Setup tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
          return new bootstrap.Tooltip(tooltipTriggerEl);
        });
        
        // Setup copy buttons
        setupCopyButtons();
        
        // Get reference from URL
        const urlParams = new URLSearchParams(window.location.search);
        const refCode = urlParams.get('ref');
        
        if (!refCode) {
          showToast('No reference code provided in the URL.', 'warning');
          return;
        }
        
        document.getElementById('ref-code').value = refCode;
        
        try {
          // Decrypt the wallet data
          const walletData = await decryptData(refCode);
          
          if (!walletData) {
            showToast('Invalid or corrupted reference code.', 'danger');
            return;
          }
          
          // Extract wallet address
          const walletAddress = walletData.address;
          
          // Set wallet address
          document.getElementById('wallet-address').value = walletAddress;
          
          // Update hide wallet status
          const hideWalletBadge = document.getElementById('hide-wallet-badge');
          if (walletData.hideWallet === true) {
            hideWalletBadge.textContent = 'Hidden';
            hideWalletBadge.classList.add('bg-warning');
            document.getElementById('hide-wallet-status').innerHTML = 'Wallet Address Hidden <i class="fas fa-eye-slash ms-1"></i>';
          } else {
            hideWalletBadge.textContent = 'Visible';
            hideWalletBadge.classList.add('bg-success');
            document.getElementById('hide-wallet-status').innerHTML = 'Wallet Address Visible <i class="fas fa-eye ms-1"></i>';
          }
          
          // Reconstruct payment URL
          const origin = window.location.origin;
          const params = new URLSearchParams();
          params.append('waddr', refCode);
          
          // Try to get providers from URL
          const providersParam = urlParams.get('providers');
          if (providersParam) {
            params.append('providers', providersParam);
          } else {
            document.getElementById('provider-restrictions-badge').textContent = 'Not Active';
            document.getElementById('provider-restrictions-badge').classList.remove('bg-success');
            document.getElementById('provider-restrictions-badge').classList.add('bg-secondary');
          }
          
          const paymentUrl = `${origin}/merchant-payment?${params.toString()}`;
          document.getElementById('payment-url').value = paymentUrl;
          document.getElementById('open-payment-link').href = paymentUrl;
          
          showToast('Tracking information loaded successfully.', 'success');
        } catch (error) {
          console.error('Error processing reference code:', error);
          showToast('Error processing reference code. Please try again.', 'danger');
        }
      });
      
      // Theme toggling
      const themeToggle = document.getElementById('theme-toggle');
      if (themeToggle) {
        // Get stored theme or use browser preference
        let storedTheme = localStorage.getItem('theme');
        if (!storedTheme) {
          storedTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
          localStorage.setItem('theme', storedTheme);
        }
        
        // Apply theme to body
        document.body.setAttribute('data-bs-theme', storedTheme);
        document.body.setAttribute('data-theme', storedTheme);
        
        // Update toggle button
        if (storedTheme === 'dark') {
          themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
          themeToggle.classList.add('btn-outline-light');
          themeToggle.classList.remove('btn-outline-dark');
        } else {
          themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
          themeToggle.classList.add('btn-outline-dark');
          themeToggle.classList.remove('btn-outline-light');
        }
        
        // Add click listener
        themeToggle.addEventListener('click', () => {
          const currentTheme = document.body.getAttribute('data-bs-theme') || 'light';
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          
          // Save and apply new theme
          localStorage.setItem('theme', newTheme);
          document.body.setAttribute('data-bs-theme', newTheme);
          document.body.setAttribute('data-theme', newTheme);
          
          // Update button appearance
          if (newTheme === 'dark') {
            themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            themeToggle.classList.add('btn-outline-light');
            themeToggle.classList.remove('btn-outline-dark');
          } else {
            themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            themeToggle.classList.add('btn-outline-dark');
            themeToggle.classList.remove('btn-outline-light');
          }
        });
      }
    </script>
  </body>
</html> 